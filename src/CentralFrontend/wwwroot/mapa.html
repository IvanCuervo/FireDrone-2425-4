<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Mapa</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Para icono del avión-->
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="https://masajid390.github.io/BeautifyMarker/leaflet-beautify-marker-icon.css">
    <script type="text/javascript" src="https://masajid390.github.io/BeautifyMarker/leaflet-beautify-marker-icon.js"></script>

    <link rel="stylesheet" href="https://maxwell-ilai.github.io/Leaflet.SidePanel/dist/leaflet-sidepanel.css" />
    <script src="https://maxwell-ilai.github.io/Leaflet.SidePanel/dist/leaflet-sidepanel.min.js"></script>

    <link rel="stylesheet" href="css/estilos.css">

    <style>
        body {
            padding: 0;
            margin: 0;
        }

        html, body, #mapid {
            height: 100%;
            width: 100%;
        }
    </style>
</head>
<body id="body">

    <div class="menu__side" id="menu_side">

        <div class="name__page">
            <i>
                <svg style="margin-top: -7px;" viewBox="0 0 24 24" width="32" height="32" xmlns="http://www.w3.org/2000/svg">
                    <g>
                        <path d="M0 0h24v24H0z" fill="none" />
                        <path fill="white" d="M12 23a7.5 7.5 0 0 0 7.5-7.5c0-.866-.23-1.697-.5-2.47-1.667 1.647-2.933 2.47-3.8 2.47 3.995-7 1.8-10-4.2-14 .5 5-2.796 7.274-4.138 8.537A7.5 7.5 0 0 0 12 23zm.71-17.765c3.241 2.75 3.257 4.887.753 9.274-.761 1.333.202 2.991 1.737 2.991.688 0 1.384-.2 2.119-.595a5.5 5.5 0 1 1-9.087-5.412c.126-.118.765-.685.793-.71.424-.38.773-.717 1.118-1.086 1.23-1.318 2.114-2.78 2.566-4.462z" fill-rule="nonzero" />
                    </g>
                </svg>
            </i>
            <h4 style="margin-top: -10px;">ServiDron</h4>
        </div>

        <div class="options__menu">

            <a href="index.html">
                <div class="option">
                    <i class="fas fa-home" title="Inicio"></i>
                    <h4>Inicio</h4>
                </div>
            </a>

            <a href="#" class="selected">
                <div class="option">
                    <i title="Mapa">
                        <svg style="margin-left: -2px;" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-geo-alt" viewBox="0 0 16 16">
                            <path d="M12.166 8.94c-.524 1.062-1.234 2.12-1.96 3.07A31.493 31.493 0 0 1 8 14.58a31.481 31.481 0 0 1-2.206-2.57c-.726-.95-1.436-2.008-1.96-3.07C3.304 7.867 3 6.862 3 6a5 5 0 0 1 10 0c0 .862-.305 1.867-.834 2.94zM8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10z" />
                            <path d="M8 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 1a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />
                        </svg>
                    </i>
                    <h4>Mapa</h4>
                </div>
            </a>

            <a href="planvuelo.html">
                <div class="option">
                    <i title="Plan de vuelo">
                        <svg style="enable-background:new 0 0 24 24; margin: -5px" height="30px" version="1.1" viewBox="0 0 24 24" fill="currentColor" width="30px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><style type="text/css">
                                                                                                                                                                                                                                                                           }
</style><g id="Layer_Grid" /><g id="Layer_2">
                        <path d="M21.5,7.5C21,7,20.4,6.8,19.8,6.9l-0.6,0C17.5,7,16,7.5,14.7,8.4l-6.6-3c-0.3-0.1-0.6-0.1-0.9,0L4.6,6.9   C4.3,7.1,4.1,7.4,4.1,7.7s0.1,0.6,0.4,0.9l4.8,4l-1.5,1.2l-2.4-1c-0.3-0.1-0.6-0.1-0.9,0l-1.7,1c-0.3,0.2-0.5,0.5-0.5,0.8   s0.1,0.7,0.4,0.9L5,17.3c0.8,0.6,1.8,1,2.8,1c0.8,0,1.5-0.2,2.2-0.6l11.1-6.3c0.8-0.4,1.2-1.3,1.2-2.2c0,0,0,0,0,0   C22.2,8.5,22,7.9,21.5,7.5z M20.1,9.6L9,15.9c-0.9,0.5-2,0.4-2.8-0.2l-1.2-1l0,0l2.5,1.1c0.3,0.1,0.7,0.1,1-0.1l3-2.3   c0.2-0.2,0.4-0.5,0.4-0.8c0-0.3-0.1-0.6-0.4-0.8L6.8,7.9l0.9-0.5l6.6,3.1c0.3,0.2,0.7,0.1,1-0.1c1.1-0.9,2.5-1.4,3.9-1.5l0.6,0   c0.1,0,0.2,0,0.3,0.1c0,0,0.1,0.1,0.1,0.3C20.3,9.4,20.2,9.5,20.1,9.6z" /></g>
                        </svg>
                    </i>
                    <h4>Plan de vuelo</h4>
                </div>
            </a>

            <a href="drones.html">
                <div class="option">
                    <i title="Control de drones">
                        <svg style="margin: -5px" enable-background="new 0 0 512 512" height="30px" version="1.1" viewBox="0 0 512 512" fill="currentColor" width="30px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g><g><g>
                        <path clip-rule="evenodd" d="M256.115,255.272c-7.784,0.01-14.438,2.782-19.96,8.321      c-5.539,5.521-8.315,12.175-8.322,19.959c0.007,7.802,2.783,14.475,8.322,20.017c5.522,5.519,12.176,8.273,19.96,8.262      c7.806,0.012,14.478-2.743,20.021-8.262c5.519-5.542,8.274-12.215,8.263-20.017c0.012-7.784-2.744-14.438-8.263-19.959      C270.593,258.055,263.921,255.282,256.115,255.272z M278.986,189.171h1.339c10.268,0.242,19.211,1.89,26.828,4.946      c7.759,3.14,14.14,7.756,19.146,13.848h90.086v-26.067c-11.027-0.209-21.211-0.714-30.552-1.513      c-6.636-0.569-12.842-1.287-18.623-2.154c-16.513-2.431-24.775-5.359-24.792-8.786c0.017-3.409,8.279-6.338,24.792-8.786      c13.956-2.02,30.349-3.184,49.175-3.491v-1.222c-0.018-1.436,0.196-2.773,0.64-4.016c0.565-1.758,1.536-3.349,2.909-4.771      c2.41-2.394,5.319-3.578,8.729-3.55c3.451-0.028,6.401,1.156,8.848,3.55c2.323,2.355,3.544,5.167,3.664,8.437      c0,0.116,0,0.232,0,0.351v1.222c6.393,0.179,12.503,0.47,18.331,0.873c9.955,0.558,19.053,1.431,27.295,2.618      c0.474,0.089,0.939,0.186,1.396,0.291c15.626,2.372,23.462,5.203,23.512,8.495c-0.05,3.33-7.886,6.181-23.512,8.554      c-0.457,0.085-0.923,0.162-1.396,0.232c-13.051,1.961-28.259,3.144-45.626,3.55v26.185H452c3.431,0.012,6.36,1.233,8.788,3.666      c2.433,2.408,3.655,5.318,3.665,8.729c-0.007,2.427-0.628,4.599-1.862,6.517c-2.114,2.812-5.181,4.789-9.195,5.935      c-33.984,8.146-67.97,16.293-101.957,24.439l38.934,81.582c0.226,0.402,0.439,0.812,0.639,1.221      c9.332,26.235,2.833,47.242-19.495,63.019c-2.808,2.014-5.89,2.753-9.252,2.212c-3.325-0.616-5.965-2.341-7.915-5.181      c-2.017-2.798-2.756-5.882-2.212-9.251c0.584-3.343,2.273-6,5.064-7.971c12.017-8.617,15.49-20.062,10.416-34.331      l-40.911-85.362l-10.65,2.618v42.534c0.005,3.035-0.753,5.867-2.269,8.497v0.057c-1.534,2.613-3.61,4.669-6.227,6.169      l-42.948,24.729v0.06c-2.655,1.509-5.487,2.267-8.497,2.269c-3.023-0.025-5.856-0.8-8.495-2.328l-42.89-24.789l-0.118-0.057      c-2.585-1.536-4.621-3.611-6.11-6.226c-1.519-2.63-2.273-5.444-2.269-8.438v-42.478l-10.707-2.618l-40.912,85.362      c-5.073,14.27-1.603,25.714,10.416,34.331c2.792,1.971,4.48,4.628,5.063,7.971c0.546,3.369-0.193,6.453-2.209,9.251      c-1.951,2.84-4.59,4.564-7.916,5.181c-3.362,0.541-6.446-0.198-9.252-2.212c-22.328-15.776-28.827-36.783-19.495-63.019      c0.2-0.409,0.414-0.818,0.639-1.221l38.934-81.582c-33.987-8.146-67.972-16.293-101.959-24.439      c-4.015-1.146-7.079-3.123-9.193-5.935c-1.234-1.918-1.855-4.09-1.864-6.517c0.011-3.41,1.232-6.32,3.667-8.729      c2.428-2.433,5.358-3.654,8.789-3.666h10.823V181.78c-17.368-0.406-32.576-1.589-45.624-3.55      c-0.473-0.07-0.939-0.147-1.396-0.232c-15.626-2.373-23.462-5.224-23.512-8.554c0.05-3.292,7.886-6.123,23.512-8.495      c0.457-0.105,0.923-0.202,1.396-0.291c8.243-1.188,17.34-2.061,27.292-2.618c5.831-0.403,11.941-0.694,18.332-0.873v-1.222      c0-0.118,0-0.234,0-0.351c0.123-3.27,1.344-6.081,3.667-8.437c2.446-2.394,5.394-3.578,8.845-3.55      c3.413-0.028,6.322,1.156,8.729,3.55c1.375,1.423,2.346,3.014,2.91,4.771c0.446,1.242,0.659,2.58,0.641,4.016v1.222      c18.827,0.308,35.22,1.472,49.175,3.491c16.513,2.448,24.776,5.377,24.792,8.786c-0.016,3.427-8.279,6.355-24.792,8.786      c-5.781,0.867-11.989,1.585-18.622,2.154c-9.344,0.799-19.527,1.304-30.553,1.513v26.067h90.086      c5.004-6.092,11.387-10.708,19.146-13.848c7.618-3.057,16.561-4.704,26.829-4.946h1.339c1.173-0.039,2.373-0.039,3.607,0h38.524      C276.61,189.132,277.813,189.132,278.986,189.171z" /></g><g>
                        <path clip-rule="evenodd" d="M256.058,269.413c3.901,0.014,7.238,1.411,10.01,4.188      c2.76,2.751,4.137,6.069,4.133,9.951c0.004,3.901-1.373,7.237-4.133,10.009c-2.771,2.759-6.108,4.137-10.01,4.13      c-3.883,0.007-7.199-1.371-9.952-4.13c-2.78-2.771-4.176-6.107-4.189-10.009c0.014-3.882,1.409-7.2,4.189-9.951      C248.858,270.824,252.175,269.427,256.058,269.413z" /></g></g></g>
            </svg>
                    </i>
                    <h4>Control de drones</h4>
                </div>
            </a>

        </div>

    </div>


    <main class="mainMapa" style="width: calc(100% - 80px);">
        <div id="mapid">
            <!-- Side Panel left -->
            <div id="mySidepanelLeft" class="sidepanel" aria-label="side panel" aria-hidden="false">
                <div class="sidepanel-inner-wrapper">
                    <a href="#" class="sidebar-tab-link" role="tab" data-tab-link="tab-1">
                    </a>
                    <div class="sidepanel-content-wrapper" style="margin-left: -40px">
                        <div class="sidepanel-content">
                            <div class="sidepanel-tab-content" data-tab-content="tab-1">
                                <h4>Drones</h4>
                                <div id="drone-list"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="sidepanel-toggle-container">
                    <button class="sidepanel-toggle-button" type="button" aria-label="toggle side panel"></button>
                </div>
            </div>

        </div>
    </main>

    <script>
        document.getElementById("btn_open").addEventListener("click", open_close_menu);

        var side_menu = document.getElementById("menu_side");
        var btn_open = document.getElementById("btn_open");
        var body = document.getElementById("body");

        function open_close_menu() {
            body.classList.toggle("body_move");
            side_menu.classList.toggle("menu__side_move");
        }

        if (window.innerWidth < 760) {

            body.classList.add("body_move");
            side_menu.classList.add("menu__side_move");
        }

        window.addEventListener("resize", function () {

            if (window.innerWidth > 760) {

                body.classList.remove("body_move");
                side_menu.classList.remove("menu__side_move");
            }

            if (window.innerWidth < 760) {

                body.classList.add("body_move");
                side_menu.classList.add("menu__side_move");
            }

        });
    </script>

    <script>
        // Creación de mapa con leaflet

        // Se crea un mapa centrado en Gijón
        var map = L.map('mapid').setView([43.5322, -5.6611], 13);

        L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
        }).addTo(map);

        // Capa para mostrar los drones
        var droneLayer = L.layerGroup().addTo(map);

        // Capa para mostrar las líneas
        var lineLayer = L.layerGroup().addTo(map);

        var last_positions = {};

    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.7/signalr.js"></script>

    <script>
        // Conexión con SignalR y recepción de mensajes

        // Se crea la conexión con SignalR en la URL configurada
        var connection = new signalR.HubConnectionBuilder()
            .withUrl("http://localhost:5285/updatemaphub") // CAMBIAR!! AHORA MISMO RUTA CON REFERENCIA A PUERTO
            .withAutomaticReconnect()
            .configureLogging(signalR.LogLevel.Debug)
            .build();

        async function start() {
            try {
                await connection.start();
                console.log("SignalR Connected.");
            } catch (err) {
                console.log(err);
            }
        };

        connection.onclose(async () => {
            await start();
        });

        start();


        // Se registra un callback para recibir un mensaje
        connection.on("UpdateMapNotification", function (message) {

            // Borrar marcadores actuales
            droneLayer.clearLayers();

            // Tipo de icono
            var options = {
                icon: "plane",
                borderColor: '#b3334f',
                textColor: '#b3334f'
            };

            var list = document.getElementById("drone-list");
            list.replaceChildren();

            // Se representan los drones en el mapa
            var drones = JSON.parse(message);
            for (var i = 0; i < drones.length; i++) {
                // Dibujar icono sobre la posición del dron
                L.marker([drones[i].Latitude, drones[i].Longitude], {
                    icon: L.BeautifyIcon.icon(options),
                    draggable: false
                }).addTo(droneLayer).bindPopup(drones[i].Name);

                // Dibujar una línea desde la última posición conocida de ese dron
                if (last_positions[drones[i].Name] !== undefined) {
                    pts = [
                        [last_positions[drones[i].Name].Latitude, last_positions[drones[i].Name].Longitude],
                        [drones[i].Latitude, drones[i].Longitude]
                    ];
                    var visual_points = L.polyline(pts, { color: "#FF2C2C" }).addTo(lineLayer);
                }
                last_positions[drones[i].Name] = drones[i];

                var tagDrone = document.createElement("h5");
                var text = document.createTextNode(drones[i].Name);
                tagDrone.appendChild(text);
                list.appendChild(tagDrone);

                var tagInfo = document.createElement("p");
                var text = document.createTextNode(`Lat ${drones[i].Latitude}, Long ${drones[i].Longitude}`);
                tagInfo.appendChild(text);
                list.appendChild(tagInfo);
            }
            console.log(message);
        });


        const sidepanelLeft = L.control.sidepanel('mySidepanelLeft', {
            tabsPosition: 'left',
            startTab: 'tab-1'
        }).addTo(map);

    </script>

</body>
</html>